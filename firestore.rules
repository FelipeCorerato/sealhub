rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== COMPANIES (Clientes) =====
    match /companies/{companyId} {
      // Qualquer usuário autenticado pode ler
      allow read: if request.auth != null;
      
      // Qualquer usuário autenticado pode criar
      allow create: if request.auth != null
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.cnpj is string
        && request.resource.data.name is string
        && request.resource.data.address is string
        && request.resource.data.type in ['headquarters', 'branch']
        && request.resource.data.status in ['active', 'closed', 'suspended'];
      
      // Qualquer usuário autenticado pode atualizar
      allow update: if request.auth != null
        && request.resource.data.cnpj == resource.data.cnpj; // CNPJ não pode mudar
      
      // Apenas o criador ou admin pode deletar
      allow delete: if request.auth != null
        && resource.data.createdBy == request.auth.uid;
    }
    
    // ===== CAMPAIGNS =====
    match /campaigns/{campaignId} {
      // Qualquer usuário autenticado pode ler
      allow read: if request.auth != null;
      
      // Qualquer usuário autenticado pode criar
      allow create: if request.auth != null
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.updatedBy == request.auth.uid
        && request.resource.data.name is string
        && request.resource.data.sender is string
        && request.resource.data.observation is string
        && request.resource.data.status in ['draft', 'active', 'completed', 'cancelled'];
      
      // Qualquer usuário autenticado pode atualizar
      // Garante que updatedBy seja o usuário atual
      allow update: if request.auth != null
        && request.resource.data.updatedBy == request.auth.uid
        && request.resource.data.createdBy == resource.data.createdBy; // createdBy não pode mudar
      
      // Apenas o criador pode deletar
      allow delete: if request.auth != null
        && resource.data.createdBy == request.auth.uid;
    }
    
    // ===== CAMPAIGN_CLIENTS (Futuro) =====
    match /campaignClients/{campaignClientId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // ===== SEALS (Futuro) =====
    match /seals/{sealId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // ===== USERS (Perfis de Usuários) =====
    match /users/{userId} {
      // Qualquer usuário autenticado pode ler perfis
      allow read: if request.auth != null;
      
      // Apenas o próprio usuário pode criar/atualizar seu perfil
      allow create, update: if request.auth != null
        && request.auth.uid == userId;
      
      // Ninguém pode deletar perfis de usuários
      allow delete: if false;
    }
  }
}

